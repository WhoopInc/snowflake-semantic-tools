snowflake_metrics:
  # Window function examples
  - name: running_total_revenue
    expr: |
      SUM({{ column('transactions', 'amount') }}) OVER (
        ORDER BY {{ column('transactions', 'transaction_date') }}
        ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW
      )
    entity_attribute: running_total
    table_name: "{{ table('transactions') }}"
    description: Running total of revenue
    
  - name: moving_average_7day
    expr: |
      AVG({{ column('transactions', 'amount') }}) OVER (
        ORDER BY {{ column('transactions', 'transaction_date') }}
        ROWS BETWEEN 6 PRECEDING AND CURRENT ROW
      )
    entity_attribute: moving_avg_7d
    table_name: "{{ table('transactions') }}"
    description: 7-day moving average
    
  - name: rank_by_revenue
    expr: |
      RANK() OVER (
        PARTITION BY {{ column('users', 'country') }}
        ORDER BY {{ column('transactions', 'total_revenue') }} DESC
      )
    entity_attribute: revenue_rank
    table_name: "{{ table('users') }}"
    description: Rank users by revenue within country
    
  - name: percentile_distribution
    expr: |
      PERCENT_RANK() OVER (
        ORDER BY {{ column('orders', 'amount') }}
      )
    entity_attribute: percentile_rank
    table_name: "{{ table('orders') }}"
    description: Percentile rank of order amounts
    
  - name: lag_comparison
    expr: |
      {{ column('metrics', 'current_value') }} - 
      LAG({{ column('metrics', 'current_value') }}, 1, 0) OVER (
        PARTITION BY {{ column('metrics', 'metric_type') }}
        ORDER BY {{ column('metrics', 'date') }}
      )
    entity_attribute: period_over_period_change
    table_name: "{{ table('metrics') }}"
    description: Period-over-period change
    
  - name: cumulative_distinct_count
    expr: |
      COUNT(DISTINCT {{ column('users', 'user_id') }}) OVER (
        ORDER BY {{ column('users', 'signup_date') }}
        RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW
      )
    entity_attribute: cumulative_users
    table_name: "{{ table('users') }}"
    description: Cumulative distinct user count
